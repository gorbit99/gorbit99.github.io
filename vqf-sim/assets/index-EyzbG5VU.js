var w=Object.defineProperty;var x=(l,t,s)=>t in l?w(l,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):l[t]=s;var y=(l,t,s)=>x(l,typeof t!="symbol"?t+"":t,s);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))e(a);new MutationObserver(a=>{for(const c of a)if(c.type==="childList")for(const h of c.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&e(h)}).observe(document,{childList:!0,subtree:!0});function s(a){const c={};return a.integrity&&(c.integrity=a.integrity),a.referrerPolicy&&(c.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?c.credentials="include":a.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function e(a){if(a.ep)return;a.ep=!0;const c=s(a);fetch(a.href,c)}})();const R=Number.EPSILON;function P(){return{tauAcc:3,tauMag:9,motionBiasEstEnabled:!0,restBiasEstEnabled:!0,magDistRejectionEnabled:!0,biasSigmaInit:.5,biasForgettingTime:100,biasClip:2,biasSigmaMotion:.1,biasVerticalForgettingFactor:1e-4,biasSigmaRest:.03,restMinT:1.5,restFilterTau:.5,restThGyr:2,restThAcc:.5,magCurrentTau:.05,magRefTau:20,magNormTh:.1,magDipTh:10,magNewTime:20,magNewFirstTime:5,magNewMinGyr:20,magMinUndisturbedTime:.5,magMaxRejectionTime:60,magRejectionFactor:2}}function r(l,t){return[...Array(l)].map((s,e)=>t(e))}function B(){return[0,0,0,0]}function j(){return{gyrQuat:r(4,()=>0),accQuat:r(4,()=>0),delta:0,restDetected:!1,magDistDetected:!1,lastAccLp:r(3,()=>0),accLpState:r(3,()=>r(2,()=>0)),lastAccCorrAngularRate:0,kMagInit:0,lastMagDisAngle:0,lastMagCorrAngularRate:0,bias:r(3,()=>0),biasP:r(9,()=>0),motionBiasEstRLpState:r(9,()=>r(2,()=>0)),motionBiasEstBiasLpState:r(2,()=>r(2,()=>0)),restLastSquaredDeviations:r(2,()=>0),restT:0,restLastGyrLp:r(3,()=>0),restGyrLpState:r(3,()=>r(2,()=>0)),restLastAccLp:r(3,()=>0),restAccLpState:r(3,()=>r(2,()=>0)),magRefNorm:0,magRefDip:0,magUndisturbedT:0,magRejectT:0,magCandidateNorm:0,magCandidateDip:0,magCandidateT:0,magNormDip:r(2,()=>0),magNormDipLpState:r(2,()=>r(2,()=>0))}}function v(){return{gyrTs:0,accTs:0,magTs:0,accLpB:r(3,()=>0),accLpA:r(2,()=>0),kMag:0,biasP0:0,biasV:0,biasMotionW:0,biasVerticalW:0,biasRestW:0,restGyrLpB:r(3,()=>0),restGyrLpA:r(2,()=>0),restAccLpB:r(3,()=>0),restAccLpA:r(2,()=>0),kMagRef:0,magNormDipLpB:r(3,()=>0),magNormDipLpA:r(2,()=>0)}}function d(l){return l*l}class f{constructor(t,s=-1,e=-1,a){y(this,"params",P());y(this,"state",j());y(this,"coeffs",v());a&&(this.params=a),this.coeffs.gyrTs=t,this.coeffs.accTs=s>0?s:t,this.coeffs.magTs=e>0?e:t,this.setup()}updateGyr(t){if(this.params.restBiasEstEnabled||this.params.magDistRejectionEnabled){const c=f.filterVec(t,3,this.params.restFilterTau,this.coeffs.gyrTs,this.coeffs.restGyrLpB,this.coeffs.restGyrLpA,this.state.restGyrLpState);this.state.restGyrLpState=c.state,this.state.restLastGyrLp=c.out,this.state.restLastSquaredDeviations[0]=d(t[0]-this.state.restLastGyrLp[0])+d(t[1]-this.state.restLastGyrLp[1])+d(t[2]-this.state.restLastGyrLp[2]);const h=this.params.biasClip*(Math.PI/180);(this.state.restLastSquaredDeviations[0]>=d(this.params.restThGyr*(Math.PI/180))||Math.abs(this.state.restLastGyrLp[0])>h||Math.abs(this.state.restLastGyrLp[1])>h||Math.abs(this.state.restLastGyrLp[2])>h)&&(this.state.restT=0,this.state.restDetected=!1)}const s=[t[0]-this.state.bias[0],t[1]-this.state.bias[1],t[2]-this.state.bias[2]],e=f.norm(s,3),a=e*this.coeffs.gyrTs;if(e>R){const c=Math.cos(a/2),h=Math.sin(a/2)/e,i=[c,h*s[0],h*s[1],h*s[2]];this.state.gyrQuat=f.quatMultiply(this.state.gyrQuat,i),this.state.gyrQuat=f.normalize(this.state.gyrQuat,4)}}updateAcc(t){if(t[0]==0&&t[1]==0&&t[2]==0)return;if(this.params.restBiasEstEnabled){const h=f.filterVec(t,3,this.params.restFilterTau,this.coeffs.accTs,this.coeffs.restAccLpB,this.coeffs.restAccLpA,this.state.restAccLpState);this.state.restAccLpState=h.state,this.state.restLastAccLp=h.out,this.state.restLastSquaredDeviations[1]=d(t[0]-this.state.restLastAccLp[0])+d(t[1]-this.state.restLastAccLp[1])+d(t[2]-this.state.restLastAccLp[2]),this.state.restLastSquaredDeviations[1]>=d(this.params.restThAcc)?(this.state.restT=0,this.state.restDetected=!1):(this.state.restT+=this.coeffs.accTs,this.state.restT>=this.params.restMinT&&(this.state.restDetected=!0))}let s=f.quatRotate(this.state.gyrQuat,t);const e=f.filterVec(s,3,this.params.tauAcc,this.coeffs.accTs,this.coeffs.accLpB,this.coeffs.accLpA,this.state.accLpState);this.state.accLpState=e.state,this.state.lastAccLp=e.out,s=f.quatRotate(this.state.accQuat,this.state.lastAccLp),s=f.normalize(s,3);const a=[0,0,0,0],c=Math.sqrt((s[2]+1)/2);if(c>1e-6?(a[0]=c,a[1]=.5*s[1]/c,a[2]=-.5*s[0]/c,a[3]=0):(a[0]=0,a[1]=1,a[2]=0,a[3]=0),this.state.accQuat=f.quatMultiply(a,this.state.accQuat),this.state.accQuat=f.normalize(this.state.accQuat,4),this.state.lastAccCorrAngularRate=Math.acos(s[2])/this.coeffs.accTs,this.params.motionBiasEstEnabled||this.params.restBiasEstEnabled){let h=this.params.biasClip*(Math.PI/180),i=r(9,()=>0),m=r(2,()=>0);const o=this.getQuat6D();i[0]=1-2*d(o[2])-2*d(o[3]),i[1]=2*(o[2]*o[1]-o[0]*o[3]),i[2]=2*(o[0]*o[2]+o[3]*o[1]),i[3]=2*(o[0]*o[3]+o[2]*o[1]),i[4]=1-2*d(o[1])-2*d(o[3]),i[5]=2*(o[2]*o[3]-o[1]*o[0]),i[6]=2*(o[3]*o[1]-o[0]*o[2]),i[7]=2*(o[0]*o[1]+o[3]*o[2]),i[8]=1-2*d(o[1])-2*d(o[2]),m[0]=i[0]*this.state.bias[0]+i[1]*this.state.bias[1]+i[2]*this.state.bias[2],m[1]=i[3]*this.state.bias[0]+i[4]*this.state.bias[1]+i[5]*this.state.bias[2];const b=f.filterVec(i,9,this.params.tauAcc,this.coeffs.accTs,this.coeffs.accLpB,this.coeffs.accLpA,this.state.motionBiasEstRLpState);this.state.motionBiasEstRLpState=b.state,i=b.out;const n=f.filterVec(m,2,this.params.tauAcc,this.coeffs.accTs,this.coeffs.accLpB,this.coeffs.accLpA,this.state.motionBiasEstBiasLpState);this.state.motionBiasEstBiasLpState=n.state,m=n.out;let p=r(3,()=>0),u=r(3,()=>0);if(this.state.restDetected&&this.params.restBiasEstEnabled?(u[0]=this.state.restLastGyrLp[0]-this.state.bias[0],u[1]=this.state.restLastGyrLp[1]-this.state.bias[1],u[2]=this.state.restLastGyrLp[2]-this.state.bias[2],i=f.matrix3SetToScaledIdentity(1),p.fill(this.coeffs.biasRestW)):this.params.motionBiasEstEnabled?(u[0]=-s[1]/this.coeffs.accTs+m[0]-i[0]*this.state.bias[0]-i[1]*this.state.bias[1]-i[2]*this.state.bias[2],u[1]=s[0]/this.coeffs.accTs+m[1]-i[3]*this.state.bias[0]-i[4]*this.state.bias[1]-i[5]*this.state.bias[2],u[2]=-i[6]*this.state.bias[0]-i[7]*this.state.bias[1]-i[8]*this.state.bias[2],p[0]=this.coeffs.biasMotionW,p[1]=this.coeffs.biasMotionW,p[2]=this.coeffs.biasVerticalW):p.fill(-1),this.state.biasP[0]<this.coeffs.biasP0&&(this.state.biasP[0]+=this.coeffs.biasV),this.state.biasP[4]<this.coeffs.biasP0&&(this.state.biasP[4]+=this.coeffs.biasV),this.state.biasP[8]<this.coeffs.biasP0&&(this.state.biasP[8]+=this.coeffs.biasV),p[0]>=0){u=f.clip(u,-h,h,3);let g=f.matrix3MultiplyTpsSecond(this.state.biasP,i);g=f.matrix3Multiply(i,g),g[0]+=p[0],g[4]+=p[1],g[8]+=p[2],g=f.matrix3Inv(g),g=f.matrix3MultiplyTpsFirst(i,g),g=f.matrix3Multiply(this.state.biasP,g),this.state.bias[0]+=g[0]*u[0]+g[1]*u[1]+g[2]*u[2],this.state.bias[1]+=g[3]*u[0]+g[4]*u[1]+g[5]*u[2],this.state.bias[2]+=g[6]*u[0]+g[7]*u[1]+g[8]*u[2],g=f.matrix3Multiply(g,i),g=f.matrix3Multiply(g,this.state.biasP);for(let D=0;D<9;D++)this.state.biasP[D]-=g[D];this.state.bias=f.clip(this.state.bias,-h,h,3)}}}updateMag(t){if(t[0]==0&&t[1]==0&&t[2]==0)return;let s=this.getQuat6D(),e=f.quatRotate(s,t);if(this.params.magDistRejectionEnabled){if(this.state.magNormDip[0]=f.norm(e,3),this.state.magNormDip[1]=-Math.asin(e[2]/this.state.magNormDip[0]),this.params.magCurrentTau>0){const c=f.filterVec(this.state.magNormDip,2,this.params.magCurrentTau,this.coeffs.magTs,this.coeffs.magNormDipLpB,this.coeffs.magNormDipLpA,this.state.magNormDipLpState);this.state.magNormDipLpState=c.state,this.state.magNormDip=c.out}Math.abs(this.state.magNormDip[0]-this.state.magRefNorm)<this.params.magNormTh*this.state.magRefNorm&&Math.abs(this.state.magNormDip[1]-this.state.magRefDip)<this.params.magDipTh*(Math.PI/180)?(this.state.magUndisturbedT+=this.coeffs.magTs,this.state.magUndisturbedT>=this.params.magMinUndisturbedTime&&(this.state.magDistDetected=!1,this.state.magRefNorm+=this.coeffs.kMagRef*(this.state.magNormDip[0]-this.state.magRefNorm),this.state.magRefDip+=this.coeffs.kMagRef*(this.state.magNormDip[1]-this.state.magRefDip))):(this.state.magUndisturbedT=0,this.state.magDistDetected=!0),Math.abs(this.state.magNormDip[0]-this.state.magCandidateNorm)<this.params.magNormTh*this.state.magCandidateNorm&&Math.abs(this.state.magNormDip[1]-this.state.magCandidateDip)<this.params.magDipTh*(Math.PI/180)?(f.norm(this.state.restLastGyrLp,3)>=this.params.magNewMinGyr*Math.PI/180&&(this.state.magCandidateT+=this.coeffs.magTs),this.state.magCandidateNorm+=this.coeffs.kMagRef*(this.state.magNormDip[0]-this.state.magCandidateNorm),this.state.magCandidateDip+=this.coeffs.kMagRef*(this.state.magNormDip[1]-this.state.magCandidateDip),this.state.magDistDetected&&(this.state.magCandidateT>=this.params.magNewTime||this.state.magRefNorm==0&&this.state.magCandidateT>=this.params.magNewFirstTime)&&(this.state.magRefNorm=this.state.magCandidateNorm,this.state.magRefDip=this.state.magCandidateDip,this.state.magDistDetected=!1,this.state.magUndisturbedT=this.params.magMinUndisturbedTime)):(this.state.magCandidateT=0,this.state.magCandidateNorm=this.state.magNormDip[0],this.state.magCandidateDip=this.state.magNormDip[1])}this.state.lastMagDisAngle=Math.atan2(e[0],e[1])-this.state.delta,this.state.lastMagDisAngle>Math.PI?this.state.lastMagDisAngle-=2*Math.PI:this.state.lastMagDisAngle<-Math.PI&&(this.state.lastMagDisAngle+=2*Math.PI);let a=this.coeffs.kMag;this.params.magDistRejectionEnabled&&(this.state.magDistDetected?this.state.magRejectT<=this.params.magMaxRejectionTime?(this.state.magRejectT+=this.coeffs.magTs,a=0):a/=this.params.magRejectionFactor:this.state.magRejectT=Math.max(this.state.magRejectT-this.params.magRejectionFactor*this.coeffs.magTs,0)),this.state.kMagInit!=0&&(a<this.state.kMagInit&&(a=this.state.kMagInit),this.state.kMagInit=this.state.kMagInit/(this.state.kMagInit+1),this.state.kMagInit*this.params.tauMag<this.coeffs.magTs&&(this.state.kMagInit=0)),this.state.delta+=a*this.state.lastMagDisAngle,this.state.lastMagCorrAngularRate=a*this.state.lastMagDisAngle/this.coeffs.magTs,this.state.delta>Math.PI?this.state.delta-=2*Math.PI:this.state.delta<-Math.PI&&(this.state.delta+=2*Math.PI)}update(t,s,e){this.updateGyr(t),this.updateAcc(s),e&&this.updateMag(e)}updateBatch(t,s,e,a){const c=r(length,()=>B()),h=r(length,()=>B()),i=r(length,()=>0),m=r(length,()=>r(3,()=>0)),o=r(length,()=>0),b=r(length,()=>!1),n=r(length,()=>!1);for(let p=0;p<a;p++)e?this.update(t[p],s[p],e[p]):this.update(t[p],s[p]),c[p]=this.getQuat6D(),h[p]=this.getQuat9D(),i[p]=this.state.delta,m[p]=this.state.bias,o[p]=this.getBiasEstimate()[0],b[p]=this.state.restDetected,n[p]=this.state.magDistDetected;return{out6D:c,out9D:h,outDelta:i,outBias:m,outBiasSigma:o,outRest:b,outMagDist:n}}getQuat3D(){return this.state.gyrQuat}getQuat6D(){return f.quatMultiply(this.state.accQuat,this.state.gyrQuat)}getQuat9D(){return f.quatApplyDelta(this.getQuat6D(),this.state.delta)}getDelta(){return this.state.delta}getBiasEstimate(){const t=Math.abs(this.state.biasP[0])+Math.abs(this.state.biasP[1])+Math.abs(this.state.biasP[2]),s=Math.abs(this.state.biasP[3])+Math.abs(this.state.biasP[4])+Math.abs(this.state.biasP[5]),e=Math.abs(this.state.biasP[6])+Math.abs(this.state.biasP[7])+Math.abs(this.state.biasP[8]),a=Math.min(Math.max(t,s,e),this.coeffs.biasP0);return[Math.sqrt(a)*(Math.PI/100/180),this.state.bias]}setBiasEstimate(t,s){if(this.state.bias=t,s>0){const e=d(s*(18e3/Math.PI));this.state.biasP=f.matrix3SetToScaledIdentity(e)}}getRestDetected(){return this.state.restDetected}getMagDistDetected(){return this.state.magDistDetected}getRelativeRestDeviations(){return[Math.sqrt(this.state.restLastSquaredDeviations[0])/(this.params.restThGyr*(Math.PI/180)),Math.sqrt(this.state.restLastSquaredDeviations[1])/this.params.restThAcc]}getMagRefNorm(){return this.state.magRefNorm}getMagRefDip(){return this.state.magRefDip}setMagRef(t,s){this.state.magRefNorm=t,this.state.magRefDip=s}setTauAcc(t){if(this.params.tauAcc==t)return;this.params.tauAcc=t;let[s,e]=f.filterCoeffs(this.params.tauAcc,this.coeffs.accTs);this.state.accLpState=f.filterAdaptStateForCoeffChange(this.state.lastAccLp,3,this.coeffs.accLpB,this.coeffs.accLpA,s,e,this.state.accLpState);const a=r(9,()=>0);for(let h=0;h<9;h++)a[h]=this.state.motionBiasEstRLpState[h][0];this.state.motionBiasEstRLpState=f.filterAdaptStateForCoeffChange(a,9,this.coeffs.accLpB,this.coeffs.accLpA,s,e,this.state.motionBiasEstRLpState);const c=r(2,()=>0);for(let h=0;h<2;h++)c[h]=this.state.motionBiasEstBiasLpState[h][0];this.state.motionBiasEstBiasLpState=f.filterAdaptStateForCoeffChange(c,2,this.coeffs.accLpB,this.coeffs.accLpA,s,e,this.state.motionBiasEstBiasLpState),this.coeffs.accLpB=s,this.coeffs.accLpA=e}setTauMag(t){this.params.tauMag=t,this.coeffs.kMag=f.gainFromTau(this.params.tauMag,this.coeffs.magTs)}setMotionBiasEstEnabled(t){this.params.motionBiasEstEnabled!=t&&(this.params.motionBiasEstEnabled=t,this.state.motionBiasEstRLpState=r(9,()=>r(2,()=>NaN)),this.state.motionBiasEstBiasLpState=r(2,()=>r(2,()=>NaN)))}setRestBiasEstEnabled(t){this.params.restBiasEstEnabled!=t&&(this.params.restBiasEstEnabled=t,this.state.restDetected=!1,this.state.restLastSquaredDeviations.fill(0),this.state.restT=0,this.state.restLastGyrLp.fill(0),this.state.restGyrLpState=r(3,()=>r(2,()=>NaN)),this.state.restLastAccLp.fill(0),this.state.restAccLpState=r(3,()=>r(2,()=>NaN)))}setMagDistRejectionEnabled(t){this.params.magDistRejectionEnabled!=t&&(this.params.magDistRejectionEnabled=t,this.state.magDistDetected=!0,this.state.magRefNorm=0,this.state.magRefDip=0,this.state.magUndisturbedT=0,this.state.magRejectT=this.params.magMaxRejectionTime,this.state.magCandidateNorm=-1,this.state.magCandidateDip=0,this.state.magCandidateT=0,this.state.magNormDipLpState=r(2,()=>r(2,()=>NaN)))}setRestDetectionThresholds(t,s){this.params.restThGyr=t,this.params.restThAcc=s}getParams(){return this.params}getCoeffs(){return this.coeffs}getState(){return this.state}setState(t){this.state=t}resetState(){this.state.gyrQuat=f.quatSetToIdentity(),this.state.accQuat=f.quatSetToIdentity(),this.state.delta=0,this.state.restDetected=!1,this.state.magDistDetected=!0,this.state.lastAccLp.fill(0),this.state.accLpState=r(3,()=>r(2,()=>NaN)),this.state.lastAccCorrAngularRate=0,this.state.kMagInit=1,this.state.lastMagDisAngle=0,this.state.lastMagCorrAngularRate=0,this.state.bias.fill(0),this.state.biasP=f.matrix3SetToScaledIdentity(this.coeffs.biasP0),this.state.motionBiasEstRLpState=r(9,()=>r(2,()=>NaN)),this.state.motionBiasEstBiasLpState=r(2,()=>r(2,()=>NaN)),this.state.restLastSquaredDeviations.fill(0),this.state.restT=0,this.state.restLastGyrLp.fill(0),this.state.restGyrLpState=r(3,()=>r(2,()=>NaN)),this.state.restLastAccLp.fill(0),this.state.restAccLpState=r(3,()=>r(2,()=>NaN)),this.state.magRefNorm=0,this.state.magRefDip=0,this.state.magUndisturbedT=0,this.state.magRejectT=this.params.magMaxRejectionTime,this.state.magCandidateNorm=-1,this.state.magCandidateDip=0,this.state.magCandidateT=0,this.state.magNormDip.fill(0),this.state.magNormDipLpState=r(2,()=>r(2,()=>NaN))}static quatMultiply(t,s){const e=t[0]*s[0]-t[1]*s[1]-t[2]*s[2]-t[3]*s[3],a=t[0]*s[1]+t[1]*s[0]+t[2]*s[3]-t[3]*s[2],c=t[0]*s[2]-t[1]*s[3]+t[2]*s[0]+t[3]*s[1],h=t[0]*s[3]+t[1]*s[2]-t[2]*s[1]+t[3]*s[0];return[e,a,c,h]}static quatConj(t){const s=t[0],e=-t[1],a=-t[2],c=-t[3];return[s,e,a,c]}static quatSetToIdentity(){return[1,0,0,0]}static quatApplyDelta(t,s){const e=Math.cos(s/2),a=Math.sin(s/2),c=e*t[0]-a*t[3],h=e*t[1]-a*t[2],i=e*t[2]+a*t[1],m=e*t[3]+a*t[0];return[c,h,i,m]}static quatRotate(t,s){const e=(1-2*t[2]*t[2]-2*t[3]*t[3])*s[0]+2*s[1]*(t[2]*t[1]-t[0]*t[3])+2*s[2]*(t[0]*t[2]+t[3]*t[1]),a=2*s[0]*(t[0]*t[3]+t[2]*t[1])+s[1]*(1-2*t[1]*t[1]-2*t[3]*t[3])+2*s[2]*(t[2]*t[3]-t[1]*t[0]),c=2*s[0]*(t[3]*t[1]-t[0]*t[2])+2*s[1]*(t[0]*t[1]+t[3]*t[2])+s[2]*(1-2*t[1]*t[1]-2*t[2]*t[2]);return[e,a,c]}static norm(t,s){let e=0;for(let a=0;a<s;a++)e+=t[a]*t[a];return Math.sqrt(e)}static normalize(t,s){const e=f.norm(t,s);if(e<R)return t;for(let a=0;a<s;a++)t[a]/=e;return t}static clip(t,s,e,a){for(let c=0;c<a;c++)t[c]<s?t[c]=s:t[c]>e&&(t[c]=e);return t}static gainFromTau(t,s){return t<0?0:t==0?1:1-Math.exp(-s/t)}static filterCoeffs(t,s){const e=Math.SQRT2/(2*Math.PI)/t,a=Math.tan(Math.PI*e*s),c=a*a+Math.sqrt(2)*a+1,h=a*a/c,i=[h,2*h,h],m=[2*(a*a-1)/c,(1-Math.sqrt(2)*a+a*a)/c];return[i,m]}static filterInitialState(t,s,e){return[t*(1-s[0]),t*(s[2]-e[1])]}static filterAdaptStateForCoeffChange(t,s,e,a,c,h,i){if(Number.isNaN(i[0][0]))return i;for(let m=0;m<s;m++)i[m][0]=i[m][0]+(e[0]-c[0])*t[m],i[m][1]=i[m][1]+(e[1]-c[1]-a[0]+h[0])*t[m];return i}static filterStep(t,s,e,a){const c=s[0]*t+a[0];return a[0]=s[1]*t-e[0]*c+a[1],a[1]=s[2]*t-e[1]*c,[c,a]}static filterVec(t,s,e,a,c,h,i){const m=r(s,()=>0);if(Number.isNaN(i[0][0])){if(Number.isNaN(i[0][1])){i[0][1]=0;for(let o=0;o<s;o++)i[Math.floor((2+o)/2)][(2+o)%2]=0}i[0][1]++;for(let o=0;o<s;o++)i[Math.floor((2+o)/2)][(2+o)%2]+=t[o],m[o]=i[Math.floor((2+o)/2)][(2+o)%2]/i[0][1];if(i[0][1]*a>=e)for(let o=0;o<s;o++)i[o]=f.filterInitialState(m[o],c,h);return{state:i,out:m}}for(let o=0;o<s;o++){const[b,n]=f.filterStep(t[o],c,h,i[o]);m[o]=b,i[o]=n}return{state:i,out:m}}static matrix3SetToScaledIdentity(t){return[t,0,0,0,t,0,0,0,t]}static matrix3Multiply(t,s){return[t[0]*s[0]+t[1]*s[3]+t[2]*s[6],t[0]*s[1]+t[1]*s[4]+t[2]*s[7],t[0]*s[2]+t[1]*s[5]+t[2]*s[8],t[3]*s[0]+t[4]*s[3]+t[5]*s[6],t[3]*s[1]+t[4]*s[4]+t[5]*s[7],t[3]*s[2]+t[4]*s[5]+t[5]*s[8],t[6]*s[0]+t[7]*s[3]+t[8]*s[6],t[6]*s[1]+t[7]*s[4]+t[8]*s[7],t[6]*s[2]+t[7]*s[5]+t[8]*s[8]]}static matrix3MultiplyTpsFirst(t,s){return[t[0]*s[0]+t[3]*s[3]+t[6]*s[6],t[0]*s[1]+t[3]*s[4]+t[6]*s[7],t[0]*s[2]+t[3]*s[5]+t[6]*s[8],t[1]*s[0]+t[4]*s[3]+t[7]*s[6],t[1]*s[1]+t[4]*s[4]+t[7]*s[7],t[1]*s[2]+t[4]*s[5]+t[7]*s[8],t[2]*s[0]+t[5]*s[3]+t[8]*s[6],t[2]*s[1]+t[5]*s[4]+t[8]*s[7],t[2]*s[2]+t[5]*s[5]+t[8]*s[8]]}static matrix3MultiplyTpsSecond(t,s){return[t[0]*s[0]+t[1]*s[1]+t[2]*s[2],t[0]*s[3]+t[1]*s[4]+t[2]*s[5],t[0]*s[6]+t[1]*s[7]+t[2]*s[8],t[3]*s[0]+t[4]*s[1]+t[5]*s[2],t[3]*s[3]+t[4]*s[4]+t[5]*s[5],t[3]*s[6]+t[4]*s[7]+t[5]*s[8],t[6]*s[0]+t[7]*s[1]+t[8]*s[2],t[6]*s[3]+t[7]*s[4]+t[8]*s[5],t[6]*s[6]+t[7]*s[7]+t[8]*s[8]]}static matrix3Inv(t){const s=t[4]*t[8]-t[5]*t[7],e=t[2]*t[7]-t[1]*t[8],a=t[1]*t[5]-t[2]*t[4],c=t[5]*t[6]-t[3]*t[8],h=t[0]*t[8]-t[2]*t[6],i=t[2]*t[3]-t[0]*t[5],m=t[3]*t[7]-t[4]*t[6],o=t[1]*t[6]-t[0]*t[7],b=t[0]*t[4]-t[1]*t[3],n=t[0]*s+t[1]*c+t[2]*m;return n>=-R&&n<=R?r(9,()=>0):[s/n,e/n,a/n,c/n,h/n,i/n,m/n,o/n,b/n]}setup(){const[t,s]=f.filterCoeffs(this.params.tauAcc,this.coeffs.accTs);this.coeffs.accLpB=t,this.coeffs.accLpA=s,this.coeffs.kMag=f.gainFromTau(this.params.tauMag,this.coeffs.magTs),this.coeffs.biasP0=d(this.params.biasSigmaInit*100),this.coeffs.biasV=d(.1*100)*this.coeffs.accTs/this.params.biasForgettingTime;const e=d(this.params.biasSigmaMotion*100);this.coeffs.biasMotionW=d(e)/this.coeffs.biasV+e,this.coeffs.biasVerticalW=this.coeffs.biasMotionW/Math.max(this.params.biasVerticalForgettingFactor,1e-10);const a=d(this.params.biasSigmaRest*100);this.coeffs.biasRestW=d(a)/this.coeffs.biasV+a;const[c,h]=f.filterCoeffs(this.params.restFilterTau,this.coeffs.gyrTs);this.coeffs.restGyrLpB=c,this.coeffs.restGyrLpA=h;const[i,m]=f.filterCoeffs(this.params.restFilterTau,this.coeffs.accTs);if(this.coeffs.restAccLpB=i,this.coeffs.restAccLpA=m,this.coeffs.kMagRef=f.gainFromTau(this.params.magRefTau,this.coeffs.magTs),this.params.magCurrentTau>0){const[o,b]=f.filterCoeffs(this.params.magCurrentTau,this.coeffs.magTs);this.coeffs.magNormDipLpB=o,this.coeffs.magNormDipLpA=b}else this.coeffs.magNormDipLpB.fill(NaN),this.coeffs.magNormDipLpA.fill(NaN);this.resetState()}}const A=document.querySelector(".vqf-params"),C=document.querySelector("#fileInput"),S=document.querySelector(".result-download"),N=document.querySelector("#sampleRate"),I=document.querySelector("#gyrHz"),G=document.querySelector("#accHz"),k=document.querySelector("#magHz"),T=document.querySelector("#useMag"),E=document.querySelector(".mag-hz-wrapper"),M=()=>S.classList.add("hidden");N.addEventListener("change",M);I.addEventListener("change",M);G.addEventListener("change",M);E.addEventListener("change",M);T.addEventListener("change",M);T.addEventListener("change",()=>{E.classList.toggle("hidden",!T.checked)});E.classList.toggle("hidden",!T.checked);const L=P();A==null||A.append(...Object.keys(L).map(l=>typeof L[l]=="boolean"?z(l):W(l)));function z(l){const t=document.createElement("div");t.classList.add("input__wrapper","input__wrapper--boolean");const s=document.createElement("label");s.classList.add("input__label"),s.htmlFor="input-"+l,s.innerText=l;const e=document.createElement("input");return e.type="checkbox",e.name=l,e.id="input-"+l,e.checked=L[l],e.addEventListener("change",()=>{L[l]=e.checked,M()}),t.append(s,e),t}function W(l){const t=document.createElement("div");t.classList.add("input__wrapper","input__wrapper--number");const s=document.createElement("label");s.classList.add("input__label"),s.htmlFor="input-"+l,s.innerText=l;const e=document.createElement("input");return e.type="number",e.name=l,e.id="input-"+l,e.value=L[l].toString(),e.addEventListener("change",()=>{L[l]=parseFloat(e.value),M()}),t.append(s,e),t}C.addEventListener("change",async()=>{var o;const l=(o=C.files)==null?void 0:o[0];if(!l){S.classList.add("hidden");return}const t=parseFloat(I.value),s=parseFloat(G.value),e=parseFloat(k.value),a=new f(1/t,1/s,T.checked?1/e:-1,L),c=await l.text(),h=[];let i=0;c.split(`
`).map(b=>{const[n,p,u,g]=b.split(";").map(D=>parseFloat(D));n===0?(a.updateGyr([p,u,g]),i++,i/t>=1/parseFloat(N.value)&&(h.push(a.getQuat6D()),i=0)):n===1?a.updateAcc([p,u,g]):a.updateMag([p,u,g])});const m=["Time;W;X;Y;Z",...h.map((b,n)=>[1/parseFloat(N.value)*n,...b].join(";"))].join(`
`);S.classList.remove("hidden"),S.addEventListener("click",()=>{const b=new Blob([m],{type:"text/csv"}),n=window.document.createElement("a");n.href=window.URL.createObjectURL(b),n.download="result.csv",document.body.appendChild(n),n.click(),document.body.removeChild(n)})});
