var w=Object.defineProperty;var x=(l,t,s)=>t in l?w(l,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):l[t]=s;var y=(l,t,s)=>x(l,typeof t!="symbol"?t+"":t,s);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))a(e);new MutationObserver(e=>{for(const c of e)if(c.type==="childList")for(const h of c.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&a(h)}).observe(document,{childList:!0,subtree:!0});function s(e){const c={};return e.integrity&&(c.integrity=e.integrity),e.referrerPolicy&&(c.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?c.credentials="include":e.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function a(e){if(e.ep)return;e.ep=!0;const c=s(e);fetch(e.href,c)}})();const R=Number.EPSILON;function P(){return{tauAcc:3,tauMag:9,motionBiasEstEnabled:!0,restBiasEstEnabled:!0,magDistRejectionEnabled:!0,biasSigmaInit:.5,biasForgettingTime:100,biasClip:2,biasSigmaMotion:.1,biasVerticalForgettingFactor:1e-4,biasSigmaRest:.03,restMinT:1.5,restFilterTau:.5,restThGyr:2,restThAcc:.5,magCurrentTau:.05,magRefTau:20,magNormTh:.1,magDipTh:10,magNewTime:20,magNewFirstTime:5,magNewMinGyr:20,magMinUndisturbedTime:.5,magMaxRejectionTime:60,magRejectionFactor:2}}function r(l,t){return[...Array(l)].map((s,a)=>t(a))}function S(){return[0,0,0,0]}function j(){return{gyrQuat:r(4,()=>0),accQuat:r(4,()=>0),delta:0,restDetected:!1,magDistDetected:!1,lastAccLp:r(3,()=>0),accLpState:r(3,()=>r(2,()=>0)),lastAccCorrAngularRate:0,kMagInit:0,lastMagDisAngle:0,lastMagCorrAngularRate:0,bias:r(3,()=>0),biasP:r(9,()=>0),motionBiasEstRLpState:r(9,()=>r(2,()=>0)),motionBiasEstBiasLpState:r(2,()=>r(2,()=>0)),restLastSquaredDeviations:r(2,()=>0),restT:0,restLastGyrLp:r(3,()=>0),restGyrLpState:r(3,()=>r(2,()=>0)),restLastAccLp:r(3,()=>0),restAccLpState:r(3,()=>r(2,()=>0)),magRefNorm:0,magRefDip:0,magUndisturbedT:0,magRejectT:0,magCandidateNorm:0,magCandidateDip:0,magCandidateT:0,magNormDip:r(2,()=>0),magNormDipLpState:r(2,()=>r(2,()=>0))}}function v(){return{gyrTs:0,accTs:0,magTs:0,accLpB:r(3,()=>0),accLpA:r(2,()=>0),kMag:0,biasP0:0,biasV:0,biasMotionW:0,biasVerticalW:0,biasRestW:0,restGyrLpB:r(3,()=>0),restGyrLpA:r(2,()=>0),restAccLpB:r(3,()=>0),restAccLpA:r(2,()=>0),kMagRef:0,magNormDipLpB:r(3,()=>0),magNormDipLpA:r(2,()=>0)}}function d(l){return l*l}class m{constructor(t,s=-1,a=-1,e){y(this,"params",P());y(this,"state",j());y(this,"coeffs",v());e&&(this.params=e),this.coeffs.gyrTs=t,this.coeffs.accTs=s>0?s:t,this.coeffs.magTs=a>0?a:t,this.setup()}updateGyr(t){if(this.params.restBiasEstEnabled||this.params.magDistRejectionEnabled){const c=m.filterVec(t,3,this.params.restFilterTau,this.coeffs.gyrTs,this.coeffs.restGyrLpB,this.coeffs.restGyrLpA,this.state.restGyrLpState);this.state.restGyrLpState=c.state,this.state.restLastGyrLp=c.out,this.state.restLastSquaredDeviations[0]=d(t[0]-this.state.restLastGyrLp[0])+d(t[1]-this.state.restLastGyrLp[1])+d(t[2]-this.state.restLastGyrLp[2]);const h=this.params.biasClip*(Math.PI/180);(this.state.restLastSquaredDeviations[0]>=d(this.params.restThGyr*(Math.PI/180))||Math.abs(this.state.restLastGyrLp[0])>h||Math.abs(this.state.restLastGyrLp[1])>h||Math.abs(this.state.restLastGyrLp[2])>h)&&(this.state.restT=0,this.state.restDetected=!1)}const s=[t[0]-this.state.bias[0],t[1]-this.state.bias[1],t[2]-this.state.bias[2]],a=m.norm(s,3),e=a*this.coeffs.gyrTs;if(a>R){const c=Math.cos(e/2),h=Math.sin(e/2)/a,i=[c,h*s[0],h*s[1],h*s[2]];this.state.gyrQuat=m.quatMultiply(this.state.gyrQuat,i),this.state.gyrQuat=m.normalize(this.state.gyrQuat,4)}}updateAcc(t){if(t[0]==0&&t[1]==0&&t[2]==0)return;if(this.params.restBiasEstEnabled){const h=m.filterVec(t,3,this.params.restFilterTau,this.coeffs.accTs,this.coeffs.restAccLpB,this.coeffs.restAccLpA,this.state.restAccLpState);this.state.restAccLpState=h.state,this.state.restLastAccLp=h.out,this.state.restLastSquaredDeviations[1]=d(t[0]-this.state.restLastAccLp[0])+d(t[1]-this.state.restLastAccLp[1])+d(t[2]-this.state.restLastAccLp[2]),this.state.restLastSquaredDeviations[1]>=d(this.params.restThAcc)?(this.state.restT=0,this.state.restDetected=!1):(this.state.restT+=this.coeffs.accTs,this.state.restT>=this.params.restMinT&&(this.state.restDetected=!0))}let s=r(3,()=>0);s=m.quatRotate(this.state.gyrQuat,t);const a=m.filterVec(s,3,this.params.tauAcc,this.coeffs.accTs,this.coeffs.accLpB,this.coeffs.accLpA,this.state.accLpState);this.state.accLpState=a.state,this.state.lastAccLp=a.out,s=m.quatRotate(this.state.accQuat,this.state.lastAccLp),s=m.normalize(s,3);const e=[0,0,0,0],c=Math.sqrt((s[2]+1)/2);if(c>1e-6?(e[0]=c,e[1]=.5*s[1]/c,e[2]=-.5*s[0]/c,e[3]=0):(e[0]=0,e[1]=1,e[2]=0,e[3]=0),this.state.accQuat=m.quatMultiply(e,this.state.accQuat),this.state.accQuat=m.normalize(this.state.accQuat,4),this.state.lastAccCorrAngularRate=Math.acos(s[2])/this.coeffs.accTs,this.params.motionBiasEstEnabled||this.params.restBiasEstEnabled){let h=this.params.biasClip*(Math.PI/180),i=S(),o=r(9,()=>0),f=r(2,()=>0);i=this.getQuat6D(),o[0]=1-2*d(i[2])-2*d(i[3]),o[1]=2*(i[2]*i[1]-i[0]*i[3]),o[2]=2*(i[0]*i[2]+i[3]*i[1]),o[3]=2*(i[0]*i[3]+i[2]*i[1]),o[4]=1-2*d(i[1])-2*d(i[3]),o[5]=2*(i[2]*i[3]-i[1]*i[0]),o[6]=2*(i[3]*i[1]-i[0]*i[2]),o[7]=2*(i[0]*i[1]+i[3]*i[2]),o[8]=1-2*d(i[1])-2*d(i[2]),f[0]=o[0]*this.state.bias[0]+o[1]*this.state.bias[1]+o[2]*this.state.bias[2],f[1]=o[3]*this.state.bias[0]+o[4]*this.state.bias[1]+o[5]*this.state.bias[2];const b=m.filterVec(o,9,this.params.tauAcc,this.coeffs.accTs,this.coeffs.accLpB,this.coeffs.accLpA,this.state.motionBiasEstRLpState);this.state.motionBiasEstRLpState=b.state,o=b.out;const n=m.filterVec(f,2,this.params.tauAcc,this.coeffs.accTs,this.coeffs.accLpB,this.coeffs.accLpA,this.state.motionBiasEstBiasLpState);this.state.motionBiasEstBiasLpState=n.state,f=n.out;let g=r(3,()=>0),u=r(3,()=>0);if(this.state.restDetected&&this.params.restBiasEstEnabled?(u[0]=this.state.restLastGyrLp[0]-this.state.bias[0],u[1]=this.state.restLastGyrLp[1]-this.state.bias[1],u[2]=this.state.restLastGyrLp[2]-this.state.bias[2],o=m.matrix3SetToScaledIdentity(1),g.fill(this.coeffs.biasRestW)):this.params.motionBiasEstEnabled?(u[0]=-s[1]/this.coeffs.accTs+f[0]-o[0]*this.state.bias[0]-o[1]*this.state.bias[1]-o[2]*this.state.bias[2],u[1]=s[0]/this.coeffs.accTs+f[1]-o[3]*this.state.bias[0]-o[4]*this.state.bias[1]-o[5]*this.state.bias[2],u[2]=-o[6]*this.state.bias[0]-o[7]*this.state.bias[1]-o[8]*this.state.bias[2],g[0]=this.coeffs.biasMotionW,g[1]=this.coeffs.biasMotionW,g[2]=this.coeffs.biasVerticalW):g.fill(-1),this.state.biasP[0]<this.coeffs.biasP0&&(this.state.biasP[0]+=this.coeffs.biasV),this.state.biasP[4]<this.coeffs.biasP0&&(this.state.biasP[4]+=this.coeffs.biasV),this.state.biasP[8]<this.coeffs.biasP0&&(this.state.biasP[8]+=this.coeffs.biasV),g[0]>=0){u=m.clip(u,-h,h,3);let p=r(9,()=>0);p=m.matrix3MultiplyTpsSecond(this.state.biasP,o),p=m.matrix3Multiply(o,p),p[0]+=g[0],p[4]+=g[1],p[8]+=g[2],p=m.matrix3Inv(p),p=m.matrix3MultiplyTpsFirst(o,p),p=m.matrix3Multiply(this.state.biasP,p),this.state.bias[0]+=p[0]*u[0]+p[1]*u[1]+p[2]*u[2],this.state.bias[1]+=p[3]*u[0]+p[4]*u[1]+p[5]*u[2],this.state.bias[2]+=p[6]*u[0]+p[7]*u[1]+p[8]*u[2],p=m.matrix3Multiply(p,o),p=m.matrix3Multiply(p,this.state.biasP);for(let D=0;D<9;D++)this.state.biasP[D]-=p[D];this.state.bias=m.clip(this.state.bias,-h,h,3)}}}updateMag(t){if(t[0]==0&&t[1]==0&&t[2]==0)return;let s=r(3,()=>0),a=S();if(a=this.getQuat6D(),s=m.quatRotate(a,t),this.params.magDistRejectionEnabled){if(this.state.magNormDip[0]=m.norm(s,3),this.state.magNormDip[1]=-Math.asin(s[2]/this.state.magNormDip[0]),this.params.magCurrentTau>0){const c=m.filterVec(this.state.magNormDip,2,this.params.magCurrentTau,this.coeffs.magTs,this.coeffs.magNormDipLpB,this.coeffs.magNormDipLpA,this.state.magNormDipLpState);this.state.magNormDipLpState=c.state,this.state.magNormDip=c.out}Math.abs(this.state.magNormDip[0]-this.state.magRefNorm)<this.params.magNormTh*this.state.magRefNorm&&Math.abs(this.state.magNormDip[1]-this.state.magRefDip)<this.params.magDipTh*(Math.PI/180)?(this.state.magUndisturbedT+=this.coeffs.magTs,this.state.magUndisturbedT>=this.params.magMinUndisturbedTime&&(this.state.magDistDetected=!1,this.state.magRefNorm+=this.coeffs.kMagRef*(this.state.magNormDip[0]-this.state.magRefNorm),this.state.magRefDip+=this.coeffs.kMagRef*(this.state.magNormDip[1]-this.state.magRefDip))):(this.state.magUndisturbedT=0,this.state.magDistDetected=!0),Math.abs(this.state.magNormDip[0]-this.state.magCandidateNorm)<this.params.magNormTh*this.state.magCandidateNorm&&Math.abs(this.state.magNormDip[1]-this.state.magCandidateDip)<this.params.magDipTh*(Math.PI/180)?(m.norm(this.state.restLastGyrLp,3)>=this.params.magNewMinGyr*Math.PI/180&&(this.state.magCandidateT+=this.coeffs.magTs),this.state.magCandidateNorm+=this.coeffs.kMagRef*(this.state.magNormDip[0]-this.state.magCandidateNorm),this.state.magCandidateDip+=this.coeffs.kMagRef*(this.state.magNormDip[1]-this.state.magCandidateDip),this.state.magDistDetected&&(this.state.magCandidateT>=this.params.magNewTime||this.state.magRefNorm==0&&this.state.magCandidateT>=this.params.magNewFirstTime)&&(this.state.magRefNorm=this.state.magCandidateNorm,this.state.magRefDip=this.state.magCandidateDip,this.state.magDistDetected=!1,this.state.magUndisturbedT=this.params.magMinUndisturbedTime)):(this.state.magCandidateT=0,this.state.magCandidateNorm=this.state.magNormDip[0],this.state.magCandidateDip=this.state.magNormDip[1])}this.state.lastMagDisAngle=Math.atan2(s[0],s[1])-this.state.delta,this.state.lastMagDisAngle>Math.PI?this.state.lastMagDisAngle-=2*Math.PI:this.state.lastMagDisAngle<-Math.PI&&(this.state.lastMagDisAngle+=2*Math.PI);let e=this.coeffs.kMag;this.params.magDistRejectionEnabled&&(this.state.magDistDetected?this.state.magRejectT<=this.params.magMaxRejectionTime?(this.state.magRejectT+=this.coeffs.magTs,e=0):e/=this.params.magRejectionFactor:this.state.magRejectT=Math.max(this.state.magRejectT-this.params.magRejectionFactor*this.coeffs.magTs,0)),this.state.kMagInit!=0&&(e<this.state.kMagInit&&(e=this.state.kMagInit),this.state.kMagInit=this.state.kMagInit/(this.state.kMagInit+1),this.state.kMagInit*this.params.tauMag<this.coeffs.magTs&&(this.state.kMagInit=0)),this.state.delta+=e*this.state.lastMagDisAngle,this.state.lastMagCorrAngularRate=e*this.state.lastMagDisAngle/this.coeffs.magTs,this.state.delta>Math.PI?this.state.delta-=2*Math.PI:this.state.delta<-Math.PI&&(this.state.delta+=2*Math.PI)}update(t,s,a){this.updateGyr(t),this.updateAcc(s),a&&this.updateMag(a)}updateBatch(t,s,a,e){const c=r(length,()=>S()),h=r(length,()=>S()),i=r(length,()=>0),o=r(length,()=>r(3,()=>0)),f=r(length,()=>0),b=r(length,()=>!1),n=r(length,()=>!1);for(let g=0;g<e;g++)a?this.update(t[g],s[g],a[g]):this.update(t[g],s[g]),c[g]=this.getQuat6D(),h[g]=this.getQuat9D(),i[g]=this.state.delta,o[g]=this.state.bias,f[g]=this.getBiasEstimate()[0],b[g]=this.state.restDetected,n[g]=this.state.magDistDetected;return{out6D:c,out9D:h,outDelta:i,outBias:o,outBiasSigma:f,outRest:b,outMagDist:n}}getQuat3D(){return this.state.gyrQuat}getQuat6D(){return m.quatMultiply(this.state.accQuat,this.state.gyrQuat)}getQuat9D(){return m.quatApplyDelta(this.getQuat6D(),this.state.delta)}getDelta(){return this.state.delta}getBiasEstimate(){const t=Math.abs(this.state.biasP[0])+Math.abs(this.state.biasP[1])+Math.abs(this.state.biasP[2]),s=Math.abs(this.state.biasP[3])+Math.abs(this.state.biasP[4])+Math.abs(this.state.biasP[5]),a=Math.abs(this.state.biasP[6])+Math.abs(this.state.biasP[7])+Math.abs(this.state.biasP[8]),e=Math.min(Math.max(t,s,a),this.coeffs.biasP0);return[Math.sqrt(e)*(Math.PI/100/180),this.state.bias]}setBiasEstimate(t,s){if(this.state.bias=t,s>0){const a=d(s*(18e3/Math.PI));this.state.biasP=m.matrix3SetToScaledIdentity(a)}}getRestDetected(){return this.state.restDetected}getMagDistDetected(){return this.state.magDistDetected}getRelativeRestDeviations(){return[Math.sqrt(this.state.restLastSquaredDeviations[0])/(this.params.restThGyr*(Math.PI/180)),Math.sqrt(this.state.restLastSquaredDeviations[1])/this.params.restThAcc]}getMagRefNorm(){return this.state.magRefNorm}getMagRefDip(){return this.state.magRefDip}setMagRef(t,s){this.state.magRefNorm=t,this.state.magRefDip=s}setTauAcc(t){if(this.params.tauAcc==t)return;this.params.tauAcc=t;let[s,a]=m.filterCoeffs(this.params.tauAcc,this.coeffs.accTs);this.state.accLpState=m.filterAdaptStateForCoeffChange(this.state.lastAccLp,3,this.coeffs.accLpB,this.coeffs.accLpA,s,a,this.state.accLpState);const e=r(9,()=>0);for(let h=0;h<9;h++)e[h]=this.state.motionBiasEstRLpState[h][0];this.state.motionBiasEstRLpState=m.filterAdaptStateForCoeffChange(e,9,this.coeffs.accLpB,this.coeffs.accLpA,s,a,this.state.motionBiasEstRLpState);const c=r(2,()=>0);for(let h=0;h<2;h++)c[h]=this.state.motionBiasEstBiasLpState[h][0];this.state.motionBiasEstBiasLpState=m.filterAdaptStateForCoeffChange(c,2,this.coeffs.accLpB,this.coeffs.accLpA,s,a,this.state.motionBiasEstBiasLpState),this.coeffs.accLpB=s,this.coeffs.accLpA=a}setTauMag(t){this.params.tauMag=t,this.coeffs.kMag=m.gainFromTau(this.params.tauMag,this.coeffs.magTs)}setMotionBiasEstEnabled(t){this.params.motionBiasEstEnabled!=t&&(this.params.motionBiasEstEnabled=t,this.state.motionBiasEstRLpState=r(9,()=>r(2,()=>NaN)),this.state.motionBiasEstBiasLpState=r(2,()=>r(2,()=>NaN)))}setRestBiasEstEnabled(t){this.params.restBiasEstEnabled!=t&&(this.params.restBiasEstEnabled=t,this.state.restDetected=!1,this.state.restLastSquaredDeviations.fill(0),this.state.restT=0,this.state.restLastGyrLp.fill(0),this.state.restGyrLpState=r(3,()=>r(2,()=>NaN)),this.state.restLastAccLp.fill(0),this.state.restAccLpState=r(3,()=>r(2,()=>NaN)))}setMagDistRejectionEnabled(t){this.params.magDistRejectionEnabled!=t&&(this.params.magDistRejectionEnabled=t,this.state.magDistDetected=!0,this.state.magRefNorm=0,this.state.magRefDip=0,this.state.magUndisturbedT=0,this.state.magRejectT=this.params.magMaxRejectionTime,this.state.magCandidateNorm=-1,this.state.magCandidateDip=0,this.state.magCandidateT=0,this.state.magNormDipLpState=r(2,()=>r(2,()=>NaN)))}setRestDetectionThresholds(t,s){this.params.restThGyr=t,this.params.restThAcc=s}getParams(){return this.params}getCoeffs(){return this.coeffs}getState(){return this.state}setState(t){this.state=t}resetState(){this.state.gyrQuat=m.quatSetToIdentity(),this.state.accQuat=m.quatSetToIdentity(),this.state.delta=0,this.state.restDetected=!1,this.state.magDistDetected=!0,this.state.lastAccLp.fill(0),this.state.accLpState=r(3,()=>r(2,()=>0)),this.state.lastAccCorrAngularRate=0,this.state.kMagInit=1,this.state.lastMagDisAngle=0,this.state.lastMagCorrAngularRate=0,this.state.bias.fill(0),this.state.biasP=m.matrix3SetToScaledIdentity(this.coeffs.biasP0),this.state.motionBiasEstRLpState=r(9,()=>r(2,()=>NaN)),this.state.motionBiasEstBiasLpState=r(2,()=>r(2,()=>NaN)),this.state.restLastSquaredDeviations.fill(0),this.state.restT=0,this.state.restLastGyrLp.fill(0),this.state.restGyrLpState=r(3,()=>r(2,()=>NaN)),this.state.restLastAccLp.fill(0),this.state.restAccLpState=r(3,()=>r(2,()=>NaN)),this.state.magRefNorm=0,this.state.magRefDip=0,this.state.magUndisturbedT=0,this.state.magRejectT=this.params.magMaxRejectionTime,this.state.magCandidateNorm=-1,this.state.magCandidateDip=0,this.state.magCandidateT=0,this.state.magNormDip.fill(0),this.state.magNormDipLpState=r(2,()=>r(2,()=>NaN))}static quatMultiply(t,s){const a=t[0]*s[0]-t[1]*s[1]-t[2]*s[2]-t[3]*s[3],e=t[0]*s[1]+t[1]*s[0]+t[2]*s[3]-t[3]*s[2],c=t[0]*s[2]-t[1]*s[3]+t[2]*s[0]+t[3]*s[1],h=t[0]*s[3]+t[1]*s[2]-t[2]*s[1]+t[3]*s[0];return[a,e,c,h]}static quatConj(t){const s=t[0],a=-t[1],e=-t[2],c=-t[3];return[s,a,e,c]}static quatSetToIdentity(){return[1,0,0,0]}static quatApplyDelta(t,s){const a=Math.cos(s/2),e=Math.sin(s/2),c=a*t[0]-e*t[3],h=a*t[1]-e*t[2],i=a*t[2]+e*t[1],o=a*t[3]+e*t[0];return[h,i,o,c]}static quatRotate(t,s){const a=(1-2*t[2]*t[2]-2*t[3]*t[3])*s[0]+2*s[1]*(t[2]*t[1]-t[0]*t[3])+2*s[2]*(t[0]*t[2]+t[3]*t[1]),e=2*s[0]*(t[0]*t[3]+t[2]*t[1])+s[1]*(1-2*t[1]*t[1]-2*t[3]*t[3])+2*s[2]*(t[2]*t[3]-t[1]*t[0]),c=2*s[0]*(t[3]*t[1]-t[0]*t[2])+2*s[1]*(t[0]*t[1]+t[3]*t[2])+s[2]*(1-2*t[1]*t[1]-2*t[2]*t[2]);return[a,e,c]}static norm(t,s){let a=0;for(let e=0;e<s;e++)a+=t[e]*t[e];return Math.sqrt(a)}static normalize(t,s){const a=m.norm(t,s);if(a<R)return t;for(let e=0;e<s;e++)t[e]/=a;return t}static clip(t,s,a,e){for(let c=0;c<e;c++)t[c]<s?t[c]=s:t[c]>a&&(t[c]=a);return t}static gainFromTau(t,s){return t<0?0:t==0?1:1-Math.exp(-s/t)}static filterCoeffs(t,s){const a=Math.SQRT2/(2*Math.PI)/t,e=Math.tan(Math.PI*a*s),c=e*e+Math.sqrt(2)*e+1,h=e*e/c,i=[h,2*h,h],o=[2*(e*e-1)/c,(1-Math.sqrt(2)*e+e*e)/c];return[i,o]}static filterInitialState(t,s,a){return[t*(1-s[0]),t*(s[2]-a[1])]}static filterAdaptStateForCoeffChange(t,s,a,e,c,h,i){if(Number.isNaN(i[0]))return i;for(let o=0;o<s;o++)i[o][0]=i[o][0]+(a[0]-c[0])*t[o],i[o][1]=i[o][1]+(a[1]-c[1]-e[0]+h[0])*t[o];return i}static filterStep(t,s,a,e){const c=s[0]*t+e[0];return e[0]=s[1]*t-a[0]*c+e[1],e[1]=s[2]*t-a[1]*c,[c,e]}static filterVec(t,s,a,e,c,h,i){const o=r(s,()=>0);if(Number.isNaN(i[0])){if(Number.isNaN(i[1])){i[0][1]=0;for(let f=0;f<s;f++)i[f][0]=0}i[0][1]++;for(let f=0;f<s;f++)i[f][0]+=t[f],o[f]=i[f][0]/i[0][1];if(i[0][1]*e>=a)for(let f=0;f<s;f++)i[f]=m.filterInitialState(o[f],c,h);return{state:i,out:o}}for(let f=0;f<s;f++){const[b,n]=m.filterStep(t[f],c,h,i[f]);o[f]=b,i[f]=n}return{state:i,out:o}}static matrix3SetToScaledIdentity(t){return[t,0,0,0,t,0,0,0,t]}static matrix3Multiply(t,s){return[t[0]*s[0]+t[1]*s[3]+t[2]*s[6],t[0]*s[1]+t[1]*s[4]+t[2]*s[7],t[0]*s[2]+t[1]*s[5]+t[2]*s[8],t[3]*s[0]+t[4]*s[3]+t[5]*s[6],t[3]*s[1]+t[4]*s[4]+t[5]*s[7],t[3]*s[2]+t[4]*s[5]+t[5]*s[8],t[6]*s[0]+t[7]*s[3]+t[8]*s[6],t[6]*s[1]+t[7]*s[4]+t[8]*s[7],t[6]*s[2]+t[7]*s[5]+t[8]*s[8]]}static matrix3MultiplyTpsFirst(t,s){return[t[0]*s[0]+t[3]*s[3]+t[6]*s[6],t[0]*s[1]+t[3]*s[4]+t[6]*s[7],t[0]*s[2]+t[3]*s[5]+t[6]*s[8],t[1]*s[0]+t[4]*s[3]+t[7]*s[6],t[1]*s[1]+t[4]*s[4]+t[7]*s[7],t[1]*s[2]+t[4]*s[5]+t[7]*s[8],t[2]*s[0]+t[5]*s[3]+t[8]*s[6],t[2]*s[1]+t[5]*s[4]+t[8]*s[7],t[2]*s[2]+t[5]*s[5]+t[8]*s[8]]}static matrix3MultiplyTpsSecond(t,s){return[t[0]*s[0]+t[1]*s[1]+t[2]*s[2],t[0]*s[3]+t[1]*s[4]+t[2]*s[5],t[0]*s[6]+t[1]*s[7]+t[2]*s[8],t[3]*s[0]+t[4]*s[1]+t[5]*s[2],t[3]*s[3]+t[4]*s[4]+t[5]*s[5],t[3]*s[6]+t[4]*s[7]+t[5]*s[8],t[6]*s[0]+t[7]*s[1]+t[8]*s[2],t[6]*s[3]+t[7]*s[4]+t[8]*s[5],t[6]*s[6]+t[7]*s[7]+t[8]*s[8]]}static matrix3Inv(t){const s=t[4]*t[8]-t[5]*t[7],a=t[2]*t[7]-t[1]*t[8],e=t[1]*t[5]-t[2]*t[4],c=t[5]*t[6]-t[3]*t[8],h=t[0]*t[8]-t[2]*t[6],i=t[2]*t[3]-t[0]*t[5],o=t[3]*t[7]-t[4]*t[6],f=t[1]*t[6]-t[0]*t[7],b=t[0]*t[4]-t[1]*t[3],n=t[0]*s+t[1]*c+t[2]*o;return n>=-R&&n<=R?r(9,()=>0):[s/n,a/n,e/n,c/n,h/n,i/n,o/n,f/n,b/n]}setup(){const[t,s]=m.filterCoeffs(this.params.tauAcc,this.coeffs.accTs);this.coeffs.accLpB=t,this.coeffs.accLpA=s,this.coeffs.kMag=m.gainFromTau(this.params.tauMag,this.coeffs.magTs),this.coeffs.biasP0=d(this.params.biasSigmaInit*100),this.coeffs.biasV=d(.1*100)*this.coeffs.accTs/this.params.biasForgettingTime;const a=d(this.params.biasSigmaMotion*100);this.coeffs.biasMotionW=d(a)/this.coeffs.biasV+a,this.coeffs.biasVerticalW=this.coeffs.biasMotionW/Math.max(this.params.biasVerticalForgettingFactor,1e-10);const e=d(this.params.biasSigmaRest*100);this.coeffs.biasRestW=d(e)/this.coeffs.biasV+e;const[c,h]=m.filterCoeffs(this.params.restFilterTau,this.coeffs.gyrTs);this.coeffs.restGyrLpB=c,this.coeffs.restGyrLpA=h;const[i,o]=m.filterCoeffs(this.params.restFilterTau,this.coeffs.accTs);if(this.coeffs.restAccLpB=i,this.coeffs.restAccLpA=o,this.coeffs.kMagRef=m.gainFromTau(this.params.magRefTau,this.coeffs.magTs),this.params.magCurrentTau>0){const[f,b]=m.filterCoeffs(this.params.magCurrentTau,this.coeffs.magTs);this.coeffs.magNormDipLpB=f,this.coeffs.magNormDipLpA=b}else this.coeffs.magNormDipLpB.fill(NaN),this.coeffs.magNormDipLpA.fill(NaN);this.resetState()}}const N=document.querySelector(".vqf-params"),C=document.querySelector("#fileInput"),A=document.querySelector(".result-download"),E=document.querySelector("#sampleRate"),I=document.querySelector("#gyrHz"),G=document.querySelector("#accHz"),k=document.querySelector("#magHz"),T=document.querySelector("#useMag"),B=document.querySelector(".mag-hz-wrapper"),M=()=>A.classList.add("hidden");E.addEventListener("change",M);I.addEventListener("change",M);G.addEventListener("change",M);B.addEventListener("change",M);T.addEventListener("change",M);T.addEventListener("change",()=>{B.classList.toggle("hidden",!T.checked)});B.classList.toggle("hidden",!T.checked);const L=P();N==null||N.append(...Object.keys(L).map(l=>typeof L[l]=="boolean"?z(l):W(l)));function z(l){const t=document.createElement("div");t.classList.add("input__wrapper","input__wrapper--boolean");const s=document.createElement("label");s.classList.add("input__label"),s.htmlFor="input-"+l,s.innerText=l;const a=document.createElement("input");return a.type="checkbox",a.name=l,a.id="input-"+l,a.checked=L[l],a.addEventListener("change",()=>{L[l]=a.checked,M()}),t.append(s,a),t}function W(l){const t=document.createElement("div");t.classList.add("input__wrapper","input__wrapper--number");const s=document.createElement("label");s.classList.add("input__label"),s.htmlFor="input-"+l,s.innerText=l;const a=document.createElement("input");return a.type="number",a.name=l,a.id="input-"+l,a.value=L[l].toString(),a.addEventListener("change",()=>{L[l]=parseFloat(a.value),M()}),t.append(s,a),t}C.addEventListener("change",async()=>{var f;const l=(f=C.files)==null?void 0:f[0];if(!l){A.classList.add("hidden");return}const t=parseFloat(I.value),s=parseFloat(G.value),a=parseFloat(k.value),e=new m(1/t,1/s,T.checked?1/a:-1,L),c=await l.text(),h=[];let i=0;c.split(`
`).map(b=>{const[n,g,u,p]=b.split(";").map(D=>parseFloat(D));n===0?(e.updateGyr([g,u,p]),i++,i/t>=1/parseFloat(E.value)&&(h.push(e.getQuat6D()),i=0)):n===1?e.updateAcc([g,u,p]):e.updateMag([g,u,p])});const o=["Time;W;X;Y;Z",...h.map((b,n)=>[1/parseFloat(E.value)*n,...b].join(";"))].join(`
`);A.classList.remove("hidden"),A.addEventListener("click",()=>{const b=new Blob([o],{type:"text/csv"}),n=window.document.createElement("a");n.href=window.URL.createObjectURL(b),n.download="result.csv",document.body.appendChild(n),n.click(),document.body.removeChild(n)})});
